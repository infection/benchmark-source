SHELL=bash

# See https://tech.davis-hansson.com/p/make/
MAKEFLAGS += --warn-undefined-variables
MAKEFLAGS += --no-builtin-rules

PHPUNIT_BIN = vendor/bin/phpunit
PHPUNIT = $(PHPUNIT_BIN)
RECTOR_BIN = vendor/bin/rector
RECTOR = $(RECTOR_BIN)
CODE_GENERATOR_BIN = code-generator/bin/console
CODE_GENERATOR = $(CODE_GENERATOR_BIN)
COVERAGE_DIR = dist/coverage

.DEFAULT_GOAL := generate_coverage

.PHONY: help
help:
	@printf "\033[33mUsage:\033[0m\n  make TARGET\n\n\033[32m#\n# Commands\n#---------------------------------------------------------------------------\033[0m\n"
	@fgrep -h "##" $(MAKEFILE_LIST) | fgrep -v fgrep | sed -e 's/\\$$//' | sed -e 's/##//' | awk 'BEGIN {FS = ":"}; {printf "\033[33m%s:\033[0m%s\n", $$1, $$2}'

.PHONY: generate_code
generate_code:	## Generates the auto-generated source and test code
generate_code: $(CODE_GENERATOR_BIN) code-generator/vendor
	@rm -rf src/AutoGenerated || true
	@rm -rf tests/AutoGenerated || true
	$(CODE_GENERATOR) generate


.PHONY: generate_coverage
generate_coverage:	## Executes the tests to generate the coverage reports
generate_coverage: $(PHPUNIT_BIN)
	@rm -rf $(COVERAGE_DIR)
	XDEBUG_MODE=coverage $(PHPUNIT) \
		--coverage-xml=$(COVERAGE_DIR)/xml \
		--log-junit=$(COVERAGE_DIR)/junit.xml
	@# Correct the absolute paths found
	PROJECT_ROOT=$$(pwd) && find $(COVERAGE_DIR) -type f -exec sed -i.bak "s|$${PROJECT_ROOT}|/path/to/project|g" {} \; && find $(COVERAGE_DIR) -name "*.bak" -type f -delete




.PHONY: phpunit
phpunit:	## Executes the PHPUnit tests
phpunit: $(PHPUNIT_BIN)
	XDEBUG_MODE=off $(PHPUNIT)


.PHONY: rector
rector:	## Executes the tests to generate the coverage reports
rector: $(RECTOR_BIN)
	$(RECTOR)

vendor: composer.lock
	composer install
	touch -c $@

composer.lock: composer.json
	composer update --lock
	touch -c $@
	touch -c vendor

$(PHPUNIT_BIN): vendor
	touch -c $@

$(RECTOR_BIN): vendor
	touch -c $@

code-generator/vendor:
	cd code-generator; make --file Makefile vendor
